<!-- templates/admin/product/variant/new.html -->
<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="content">

    <!-- Page header -->
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <h2 class="page-title">상품 옵션 조합 추가</h2>
                    <div class="text-secondary mt-1">
                        상품 ID: <span th:text="${productId}">1</span>
                    </div>
                </div>

                <div class="col-auto ms-auto d-print-none">
                    <div class="btn-list">
                        <a class="btn btn-outline-secondary"
                           th:href="@{|/admin/products/${productId}|}">
                            돌아가기
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page body -->
    <div class="page-body">
        <div class="container-xl">
            <div class="card">
                <div class="card-body">
                    <div class="alert alert-danger" th:if="${error}" th:text="${error}"></div>

                    <div class="alert alert-danger" th:if="${errors != null}"
                         th:text="${errors.defaultMessage}">에러
                    </div>

                    <form method="post" th:action="@{|/admin/products/${productId}/variants/create|}" th:object="${form}">
                        <th:block th:replace="~{common/fragments/csrf :: csrf}"></th:block>

                        <!-- ✅ 선택된 optionValueIds가 여기 hidden으로 생성됨 -->
                        <div id="selectedOptionValueIds"></div>

                        <!-- ✅ SKU/가격 입력 -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">SKU (선택)</label>
                                        <input type="text"
                                               class="form-control"
                                               name="sku"
                                               placeholder="예: PRD-001-RED-S"
                                               th:value="${form != null ? form.sku : ''}">
                                        <div class="form-hint">비워두면 자동/빈 값으로 처리됩니다.</div>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">옵션가 (선택)</label>
                                        <input type="number"
                                               class="form-control"
                                               name="customPrice"
                                               min="0"
                                               step="1"
                                               placeholder="예: 12900"
                                               th:value="${form != null ? form.customPrice : 0}">
                                        <div class="form-hint">0이면 상품 기본가를 사용합니다.</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-secondary mb-3">
                            옵션값을 선택해서 조합을 생성하세요.
                        </div>

                        <div class="row g-3" th:if="${options != null}">
                            <div class="col-12" th:each="option : ${options}">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="fw-bold mb-2" th:text="${option.name}">옵션명</div>

                                        <div class="d-flex flex-wrap gap-2">
                                            <label class="form-check form-check-inline"
                                                   th:each="val : ${option.optionValues}">
                                                <input class="form-check-input"
                                                       type="radio"
                                                       th:name="${'option_' + option.id}"
                                                       th:value="${val.id}">
                                                <span class="form-check-label" th:text="${val.value}">옵션값</span>
                                            </label>
                                        </div>

                                        <div class="text-secondary small mt-2">
                                            * 이 옵션은 하나만 선택할 수 있어요.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-secondary" th:if="${options == null || #lists.isEmpty(options)}">
                            등록된 옵션이 없습니다. (옵션/옵션값을 먼저 추가해주세요)
                        </div>

                        <!-- ✅ 버튼 -->
                        <div class="mt-4 d-flex gap-2">
                            <button type="submit" class="btn btn-primary">옵션 조합 생성</button>
                            <a class="btn btn-outline-secondary" th:href="@{|/admin/products/${productId}|}">취소</a>
                        </div>
                    </form>

                </div>

            </div>
        </div>
    </div>
    <script>
        (function () {
            const container = document.getElementById('selectedOptionValueIds');

            function rebuildHiddenInputs() {
                container.innerHTML = '';

                // option_ 로 시작하는 라디오 그룹들에서 체크된 것만 모음
                const checkedRadios = document.querySelectorAll('input[type="radio"][name^="option_"]:checked');

                checkedRadios.forEach(radio => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'optionValueIds';
                    input.value = radio.value;
                    container.appendChild(input);
                });
            }

            // 라디오가 바뀔 때마다 hidden 재생성
            document.addEventListener('change', (e) => {
                const el = e.target;
                if (el && el.matches('input[type="radio"][name^="option_"]')) {
                    rebuildHiddenInputs();
                }
            });

            // 혹시 초기값(기본 선택)이 있으면 반영
            rebuildHiddenInputs();
        })();
    </script>
</div>
</body>
</html>
