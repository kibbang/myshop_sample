<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="content">
    <div class="container-xl">

        <!-- header -->
        <div class="page-header d-print-none">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <div class="page-pretitle">Shop</div>
                    <h2 class="page-title" th:text="${product.name}">상품명</h2>
                </div>

                <div class="col-auto ms-auto d-print-none">
                    <a class="btn btn-outline-secondary" th:href="@{/products}">목록</a>
                </div>
            </div>
        </div>

        <!-- HERO CARD (이미지 + 핵심 정보) -->
        <div class="card mb-3">
            <div class="row g-0">
                <!-- image -->
                <div class="col-12 col-md-6">
                    <div class="ratio ratio-4x3">
                        <img class="card-img-left object-cover"
                             th:src="@{|/uploads/products/${product.id}/1.jpg|}"
                             onerror="this.onerror=null;this.src='/assets/img/product-placeholder.png';"
                             alt="product image">
                    </div>
                </div>

                <!-- summary -->
                <div class="col-12 col-md-6">
                    <div class="card-body d-flex flex-column h-100">
                        <div class="d-flex align-items-start justify-content-between">
                            <div>
                                <div class="text-secondary mb-1">
                                    ID: <span th:text="${product.id}">1</span>
                                </div>
                                <h3 class="card-title mb-2" th:text="${product.name}">상품명</h3>
                            </div>

                            <!-- 필요하면 배지 -->
                            <!-- <span class="badge bg-success-lt">판매중</span> -->
                        </div>

                        <div class="my-3">
                            <div class="h1 mb-0">
                                <span th:text="${#numbers.formatInteger(product.basePrice, 0, 'COMMA')}">10,000</span>
                                <span class="fs-3 text-secondary" th:text="${product.currency}">KRW</span>
                            </div>
                            <div class="text-secondary mt-1">VAT 포함 · 안전결제</div>
                        </div>

                        <div class="mt-auto">
                            <div class="hr-text">바로 구매</div>

                            <!-- 주문 폼 (기존 그대로) -->
                            <form th:action="@{/orders/prepare}" method="post" th:object="${orderForm}">
                                <th:block th:replace="~{common/fragments/csrf :: csrf}"></th:block>
                                <input type="hidden" th:field="*{productId}" />

                                <div class="mb-3">
                                    <label class="form-label">수량</label>
                                    <input th:id="'quantityInput'" type="number" class="form-control" min="1" th:field="*{quantity}" th:attr="data-unit-price=${product.basePrice}" />
                                    <div class="mb-3">
                                        <label class="form-label">총 금액</label>
                                        <div class="h2 mb-0">
                                            <span id="totalAmountText">0</span>
                                            <span class="text-secondary" th:text="${product.currency}">KRW</span>
                                        </div>
                                        <div class="text-secondary small">
                                            단가 <span th:text="${#numbers.formatInteger(product.basePrice, 0, 'COMMA')}">10,000</span>
                                            <span th:text="${product.currency}">KRW</span> × 수량
                                        </div>
                                    </div>

                                    <div class="invalid-feedback d-block"
                                         th:if="${#fields.hasErrors('quantity')}"
                                         th:errors="*{quantity}">
                                        수량 오류
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary w-100">
                                    주문하기
                                </button>
                            </form>

                            <div class="text-secondary mt-2 small">
                                주문 후 주문서 페이지에서 배송지 정보를 입력합니다.
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- 아래 섹션: 설명 / 안내 -->
        <div class="row row-cards">
            <div class="col-12 col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title mb-0">설명</h3>
                    </div>
                    <div class="card-body">
                        <div class="text-secondary"
                             th:if="${product.description != null and !#strings.isEmpty(product.description)}"
                             th:text="${product.description}">
                            설명
                        </div>

                        <div class="text-secondary"
                             th:if="${product.description == null or #strings.isEmpty(product.description)}">
                            등록된 설명이 없습니다.
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title mb-0">안내</h3>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled space-y-2 mb-0">
                            <li class="d-flex">
                                <span class="me-2 text-secondary">•</span>
                                <span>재고/옵션 선택은 다음 단계에서 확장 예정</span>
                            </li>
                            <li class="d-flex">
                                <span class="me-2 text-secondary">•</span>
                                <span>주문 완료 후 내 주문에서 상태 확인 가능</span>
                            </li>
                            <li class="d-flex">
                                <span class="me-2 text-secondary">•</span>
                                <span>문제 발생 시 관리자에게 문의</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        (function () {
            const quantityInput = document.getElementById('quantityInput');
            const totalText = document.getElementById('totalAmountText');
            if (!quantityInput || !totalText) return;

            const unitPrice = Number(quantityInput.dataset.unitPrice || '0');
            const formatNumber = (n) => new Intl.NumberFormat('ko-KR').format(n);

            const calc = () => {
                let quantity = Number(quantityInput.value);

                // 빈값/NaN/0/음수면 1로 교정
                if (!Number.isFinite(quantity) || quantity < 1) {
                    quantity = 1;
                    quantityInput.value = 1; // ✅ 입력값도 1로 바꿈
                }

                totalText.textContent = formatNumber(unitPrice * quantity);
            };

            quantityInput.addEventListener('input', calc);
            quantityInput.addEventListener('change', calc);
            calc();
        })();
    </script>
</div>
</body>
</html>