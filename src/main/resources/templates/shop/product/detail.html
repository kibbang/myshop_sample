<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="content">
    <div class="container-xl">

        <!-- header -->
        <div class="page-header d-print-none">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <div class="page-pretitle">Shop</div>
                    <h2 class="page-title" th:text="${product.name}">ìƒí’ˆëª…</h2>
                </div>

                <div class="col-auto ms-auto d-print-none">
                    <a class="btn btn-outline-secondary" th:href="@{/products}">ëª©ë¡</a>
                </div>
            </div>
        </div>

        <!-- HERO CARD (ì´ë¯¸ì§€ + í•µì‹¬ ì •ë³´) -->
        <div class="card mb-3">
            <div class="row g-0">
                <!-- image -->
                <div class="col-12 col-md-6">
                    <div class="ratio ratio-4x3">
                        <img id="mainProductImage"
                             class="card-img-left object-cover"
                             style="transition: opacity 120ms ease;"
                             th:src="@{|/uploads/products/${product.id}/1.jpg|}"
                             onerror="this.onerror=null;this.src='/assets/images/products/default.jpg';"
                             alt="product image">
                    </div>
                    <div class="p-3 border-top">
                        <div class="text-secondary small mb-2">ìƒí’ˆ ì´ë¯¸ì§€</div>

                        <div class="d-flex gap-2 flex-wrap">
                            <img th:each="i : ${#numbers.sequence(1,4)}"
                                 class="rounded border"
                                 style="width:72px;height:72px;object-fit:cover;cursor:pointer;"
                                 th:src="@{|/uploads/products/${product.id}/${i}.jpg|}"
                                 onerror="this.style.display='none';"
                                 onclick="swapMainImage(this.src)"
                                 th:alt="${'thumb' + i}">
                        </div>
                    </div>

                    <!-- âœ… ìƒí’ˆ í¬ì¸íŠ¸(ì™¼ìª½ ì´ë¯¸ì§€ ì•„ë˜) -->
                    <div class="p-3 border-top">
                        <div class="row g-2">

                            <div class="col-12 col-sm-4">
                                <div class="card card-sm h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <span class="me-2">âœ¨</span>
                                            <div>
                                                <div class="fw-bold">í¬ì¸íŠ¸</div>
                                                <div class="text-secondary small">ë°ì¼ë¦¬ ë² ì´ì§</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-sm-4">
                                <div class="card card-sm h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <span class="me-2">ğŸ“</span>
                                            <div>
                                                <div class="fw-bold">ìƒ‰ìƒ / ì‚¬ì´ì¦ˆ</div>
                                                <div class="text-secondary small">ì˜µì…˜ì—ì„œ ì„ íƒ</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-12 col-sm-4">
                                <div class="card card-sm h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <span class="me-2">ğŸ§¼</span>
                                            <div>
                                                <div class="fw-bold">ê´€ë¦¬</div>
                                                <div class="text-secondary small">ìƒì„¸ì„¤ëª… ì°¸ì¡°</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>

                <!-- summary -->
                <div class="col-12 col-md-6">
                    <div class="card-body d-flex flex-column h-100">
                        <div class="d-flex align-items-start justify-content-between">
                            <div>
                                <div class="text-secondary mb-1">
                                    ID: <span th:text="${product.id}">1</span>
                                </div>
                                <h3 class="card-title mb-2" th:text="${product.name}">ìƒí’ˆëª…</h3>
                            </div>
                        </div>

                        <div class="my-3">
                            <div class="h1 mb-0">
                                <span th:text="${#numbers.formatInteger(product.basePrice, 0, 'COMMA')}">10,000</span>
                                <span class="fs-3 text-secondary" th:text="${product.currency}">KRW</span>
                            </div>
                            <div class="text-secondary mt-1">VAT í¬í•¨ Â· ì•ˆì „ê²°ì œ</div>
                        </div>

                        <div class="mt-auto">
                            <div class="hr-text">ë°”ë¡œ êµ¬ë§¤</div>

                            <!-- ì£¼ë¬¸ í¼ -->
                            <form th:action="@{/orders/prepare}" method="post" th:object="${orderForm}"
                                  onsubmit="return confirmLoginBeforeOrder(event)">
                                <th:block th:replace="~{common/fragments/csrf :: csrf}"></th:block>

                                <!-- productId -->
                                <input type="hidden" th:field="*{productId}" />

                                <!-- ì„ íƒëœ variantId -->
                                <input type="hidden" id="variantId" name="variantId" />

                                <!-- ê¸°ë³¸ ì˜µì…˜ìœ¼ë¡œ ë°”ë¡œ êµ¬ë§¤ -->
                                <div class="mb-2" th:if="${defaultVariantId != null}">
                                    <button type="submit"
                                            class="btn btn-outline-primary w-100"
                                            onclick="useDefaultVariantForOrder()">
                                        ê¸°ë³¸ ì˜µì…˜ìœ¼ë¡œ ë°”ë¡œ êµ¬ë§¤
                                    </button>
                                    <div class="text-secondary small mt-1">
                                        ì˜µì…˜ì„ ì„ íƒí•˜ì§€ ì•Šì•„ë„ ê¸°ë³¸ ì¡°í•©ìœ¼ë¡œ ì£¼ë¬¸ë©ë‹ˆë‹¤.
                                    </div>
                                </div>

                                <!-- ì˜µì…˜ ì„ íƒ -->
                                <div th:if="${options != null and !options.isEmpty()}" class="mb-3">

                                    <div th:each="opt : ${options}" class="mb-3">
                                        <div class="form-label" th:text="${opt.name}">ì˜µì…˜ëª…</div>

                                        <div class="btn-group w-100 flex-wrap" role="group">
                                            <div th:each="v : ${opt.optionValues}" class="me-2 mb-2">
                                                <input type="radio"
                                                       class="btn-check"
                                                       th:id="${'opt-' + opt.id + '-v-' + v.id}"
                                                       th:name="${'opt-' + opt.id}"
                                                       th:value="${v.id}"
                                                       autocomplete="off"
                                                       onchange="onOptionChanged()">
                                                <label class="btn btn-outline-indigo"
                                                       th:for="${'opt-' + opt.id + '-v-' + v.id}"
                                                       th:text="${v.name}">ê°’</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="alert alert-info mb-0 py-2" id="variantInfo">ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”</div>
                                </div>

                                <!-- ìˆ˜ëŸ‰ -->
                                <div class="mb-3">
                                    <label class="form-label">ìˆ˜ëŸ‰</label>
                                    <input th:id="'quantityInput'"
                                           type="number"
                                           class="form-control"
                                           min="1"
                                           th:field="*{quantity}"
                                           th:attr="data-unit-price=${product.basePrice}" />

                                    <div class="mb-3 mt-3">
                                        <label class="form-label">ì´ ê¸ˆì•¡</label>
                                        <div class="h2 mb-0">
                                            <span id="totalAmountText">0</span>
                                            <span class="text-secondary" th:text="${product.currency}">KRW</span>
                                        </div>
                                        <div class="text-secondary small">
                                            ë‹¨ê°€ <span th:text="${#numbers.formatInteger(product.basePrice, 0, 'COMMA')}">10,000</span>
                                            <span th:text="${product.currency}">KRW</span> Ã— ìˆ˜ëŸ‰
                                        </div>
                                    </div>

                                    <div class="invalid-feedback d-block"
                                         th:if="${#fields.hasErrors('quantity')}"
                                         th:errors="*{quantity}">
                                        ìˆ˜ëŸ‰ ì˜¤ë¥˜
                                    </div>
                                </div>

                                <!-- ì£¼ë¬¸ ë²„íŠ¼ -->
                                <button type="submit"
                                        class="btn btn-primary w-100"
                                        id="orderBtn"
                                        th:disabled="${options != null and !options.isEmpty()}">
                                    ì˜µì…˜ ì„ íƒ í›„ ì£¼ë¬¸í•˜ê¸°
                                </button>

                                <!-- âœ… ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ -->
                                <div class="mt-2">
                                    <button type="button"
                                            class="btn btn-outline-primary w-100"
                                            onclick="submitCartForm()">
                                        ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
                                    </button>
                                </div>
                            </form>

                            <!-- âœ… ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ì „ìš© form (ìˆ¨ê¹€) -->
                            <form id="cartAddForm" th:action="@{/my/cart/items}" method="post" style="display:none;">
                                <th:block th:replace="~{common/fragments/csrf :: csrf}"></th:block>

                                <input type="hidden" name="productId" th:value="${product.id}">
                                <input type="hidden" name="variantId" id="cartVariantId">
                                <input type="hidden" name="quantity" id="cartQuantity">
                            </form>

                            <div class="text-secondary mt-2 small">
                                ì£¼ë¬¸ í›„ ì£¼ë¬¸ì„œ í˜ì´ì§€ì—ì„œ ë°°ì†¡ì§€ ì •ë³´ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.
                            </div>

                            <!-- ë°°ì†¡/ë°˜í’ˆ/ê²°ì œ ìš”ì•½ -->
                            <div class="mt-3">
                                <div class="card card-sm">
                                    <div class="card-body">

                                        <div class="d-flex align-items-start mb-3">
                                            <span class="me-2 text-secondary">ğŸšš</span>
                                            <div>
                                                <div class="fw-bold">ë°°ì†¡</div>
                                                <div class="text-secondary small">ê²°ì œ í™•ì¸ í›„ 1~2ì¼ ë‚´ ì¶œê³  (ì£¼ë§/ê³µíœ´ì¼ ì œì™¸)</div>
                                            </div>
                                        </div>

                                        <div class="d-flex align-items-start mb-3">
                                            <span class="me-2 text-secondary">ğŸ”</span>
                                            <div>
                                                <div class="fw-bold">êµí™˜/ë°˜í’ˆ</div>
                                                <div class="text-secondary small">ìˆ˜ë ¹ í›„ 7ì¼ ì´ë‚´ ê°€ëŠ¥ (ì‚¬ìš©/í›¼ì† ì‹œ ì œí•œ)</div>
                                            </div>
                                        </div>

                                        <div class="d-flex align-items-start">
                                            <span class="me-2 text-secondary">ğŸ’³</span>
                                            <div>
                                                <div class="fw-bold">ê²°ì œ ì•ˆë‚´</div>
                                                <div class="text-secondary small">ì•ˆì „ê²°ì œ ì§€ì› Â· ì˜µì…˜ ì„ íƒ í›„ ì¬ê³  í™•ì¸</div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- ì•„ë˜ ì„¹ì…˜: ì„¤ëª… / ì•ˆë‚´ -->
        <div class="row row-cards">
            <div class="col-12 col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title mb-0">ì„¤ëª…</h3>
                    </div>
                    <div class="card-body">
                        <div class="text-secondary"
                             th:if="${product.description != null and !#strings.isEmpty(product.description)}"
                             th:text="${product.description}">
                            ì„¤ëª…
                        </div>

                        <div class="text-secondary"
                             th:if="${product.description == null or #strings.isEmpty(product.description)}">
                            ë“±ë¡ëœ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title mb-0">ì•ˆë‚´</h3>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled space-y-2 mb-0">
                            <li class="d-flex">
                                <span class="me-2 text-secondary">â€¢</span>
                                <span>ì˜µì…˜ ì„ íƒ í›„ ì£¼ë¬¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
                            </li>
                            <li class="d-flex">
                                <span class="me-2 text-secondary">â€¢</span>
                                <span>ì£¼ë¬¸ ì™„ë£Œ í›„ ë‚´ ì£¼ë¬¸ì—ì„œ ìƒíƒœ í™•ì¸ ê°€ëŠ¥</span>
                            </li>
                            <li class="d-flex">
                                <span class="me-2 text-secondary">â€¢</span>
                                <span>ë¬¸ì œ ë°œìƒ ì‹œ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ì˜µì…˜ ì„ íƒ â†’ Variant ë§¤ì¹­ JS + ê¸°ë³¸ êµ¬ë§¤ ë²„íŠ¼ JS -->
    <script th:inline="javascript">
        const PRODUCT_ID = /*[[${product.id}]]*/ 0;
        const OPTION_GROUP_COUNT = /*[[${options != null ? options.size() : 0}]]*/ 0;
        const DEFAULT_VARIANT_ID = /*[[${defaultVariantId}]]*/ null;
        const IS_LOGGED_IN = /*[[${sessionView.sessionUser != null}]]*/ false;

        document.addEventListener("DOMContentLoaded", function () {
            const variantIdEl = document.getElementById("variantId");
            const orderBtn = document.getElementById("orderBtn");

            // ì˜µì…˜ì´ ì—†ëŠ” ìƒí’ˆì´ë©´ ê¸°ë³¸ variant ìë™ ì„¸íŒ… + ì£¼ë¬¸ ë²„íŠ¼ í™œì„±í™”
            if (OPTION_GROUP_COUNT === 0 && variantIdEl && DEFAULT_VARIANT_ID) {
                variantIdEl.value = DEFAULT_VARIANT_ID;
                if (orderBtn) orderBtn.disabled = false;
            }
        });

        function useDefaultVariantForOrder() {
            const variantIdEl = document.getElementById("variantId");
            const variantInfoEl = document.getElementById("variantInfo");

            if (variantIdEl && DEFAULT_VARIANT_ID) {
                variantIdEl.value = DEFAULT_VARIANT_ID;
            }
            if (variantInfoEl && DEFAULT_VARIANT_ID) {
                variantInfoEl.innerText = "ê¸°ë³¸ ì˜µì…˜ìœ¼ë¡œ ì£¼ë¬¸í•©ë‹ˆë‹¤.";
            }
        }

        async function onOptionChanged() {
            const selected = Array.from(document.querySelectorAll("input[type=radio]:checked"))
                .map(el => el.value);

            const variantIdEl = document.getElementById("variantId");
            const variantInfoEl = document.getElementById("variantInfo");
            const orderBtn = document.getElementById("orderBtn");

            // ì˜µì…˜ì„ ëª¨ë‘ ì„ íƒí•˜ì§€ ì•Šì•˜ìœ¼ë©´ ì´ˆê¸°í™”
            if (selected.length !== OPTION_GROUP_COUNT) {
                if (variantIdEl) variantIdEl.value = "";
                if (variantInfoEl) variantInfoEl.innerText = "ì˜µì…˜ì„ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”.";
                if (orderBtn) orderBtn.disabled = true;
                return;
            }

            const qs = selected.map(x => `optionValueIds=${encodeURIComponent(x)}`).join("&");
            const res = await fetch(`/api/products/${PRODUCT_ID}/variant?${qs}`);

            if (!res.ok) {
                if (variantIdEl) variantIdEl.value = "";
                if (variantInfoEl) variantInfoEl.innerText = "ì¬ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.";
                if (orderBtn) orderBtn.disabled = true;
                return;
            }

            const data = await res.json();

            if (!data.matched) {
                if (variantIdEl) variantIdEl.value = "";
                if (variantInfoEl) variantInfoEl.innerText = "ì¬ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.";
                if (orderBtn) orderBtn.disabled = true;
                return;
            }

            if (variantIdEl) variantIdEl.value = data.variantId;

            if (variantInfoEl) {
                variantInfoEl.innerText =
                    `SKU: ${data.sku ?? '-'} Â· ì¬ê³ : ${data.stockQuantity}` + (data.orderable ? "" : " (í’ˆì ˆ)");
            }

            if (orderBtn) orderBtn.disabled = !data.orderable;
        }
    </script>

    <!-- ìˆ˜ëŸ‰ ê³„ì‚° / ì´ë¯¸ì§€ êµì²´ / ì¥ë°”êµ¬ë‹ˆ submit / ë¡œê·¸ì¸ í™•ì¸ -->
    <script>
        function submitCartForm() {
            const orderVariantId = document.getElementById("variantId");
            const qtyInput = document.getElementById("quantityInput");

            const cartVariantId = document.getElementById("cartVariantId");
            const cartQuantity = document.getElementById("cartQuantity");
            const cartForm = document.getElementById("cartAddForm");

            if (!orderVariantId || !qtyInput || !cartVariantId || !cartQuantity || !cartForm) {
                alert("ì¥ë°”êµ¬ë‹ˆ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // ì˜µì…˜ ìƒí’ˆì¸ë° ì•„ì§ variant ì„ íƒ ì•ˆ ëœ ê²½ìš°
            if (!orderVariantId.value) {
                alert("ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”.");
                return;
            }

            let quantity = Number(qtyInput.value);
            if (!Number.isFinite(quantity) || quantity < 1) {
                quantity = 1;
                qtyInput.value = 1;
            }

            cartVariantId.value = orderVariantId.value;
            cartQuantity.value = String(quantity);

            cartForm.submit();
        }

        (function () {
            const quantityInput = document.getElementById('quantityInput');
            const totalText = document.getElementById('totalAmountText');
            if (!quantityInput || !totalText) return;

            const unitPrice = Number(quantityInput.dataset.unitPrice || '0');
            const formatNumber = (n) => new Intl.NumberFormat('ko-KR').format(n);

            const calc = () => {
                let quantity = Number(quantityInput.value);

                // ë¹ˆê°’/NaN/0/ìŒìˆ˜ë©´ 1ë¡œ êµì •
                if (!Number.isFinite(quantity) || quantity < 1) {
                    quantity = 1;
                    quantityInput.value = 1;
                }

                totalText.textContent = formatNumber(unitPrice * quantity);
            };

            quantityInput.addEventListener('input', calc);
            quantityInput.addEventListener('change', calc);
            calc();
        })();

        function swapMainImage(src) {
            const main = document.getElementById('mainProductImage');
            if (!main) return;

            main.style.opacity = '0.35';
            main.src = src;

            // ì´ë¯¸ì§€ ë¡œë“œë˜ë©´ ìì—°ìŠ¤ëŸ½ê²Œ ë³µê·€
            main.onload = () => {
                main.style.opacity = '1';
            };
        }

        function confirmLoginBeforeOrder(e) {
            // ì´ë¯¸ ë¡œê·¸ì¸ ìƒíƒœë©´ ê·¸ëŒ€ë¡œ ì§„í–‰
            if (typeof IS_LOGGED_IN !== "undefined" && IS_LOGGED_IN) {
                return true;
            }

            // ë¹„ë¡œê·¸ì¸: confirm ë„ìš°ê¸°
            const ok = confirm("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ ì°½ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            if (!ok) {
                if (e) e.preventDefault();
                return false;
            }
            // okë©´ submit ì§„í–‰ â†’ ì„œë²„ê°€ ì¸í„°ì…‰í„°ë¡œ /login?redirect=...ë¡œ ë³´ëƒ„
            return true;
        }
    </script>
</div>
</body>
</html>